# 高并发服务模型

[30张图解：高并发服务模型哪家强？](https://mp.weixin.qq.com/s/a2Q1DQqOHdhtGEjJ4QxPew)

## 任务类型

### CPU密集型任务

一个程序任务大部分是计算类的，比如逻辑处理、数值比较和计算，我们就称它是 CPU 密集型任务或计算密集型任务。CPU 密集型任务的特点是要进行大量的计算，消耗 CPU 资源

CPU 密集型任务虽然也可以用多任务完成，但是任务越多，任务之间切换的时间就越多，CPU 执行效率反而更低，所以要最高效地利用 CPU，任务并行数应当等于 CPU 的核心数，避免任务在 CPU 核之间频繁切换

### IO密集型任务

一个程序涉及到大量网络、磁盘等比较耗时的输入输出任务，就称它是 IO 密集型任务，这类任务的特点是 CPU 消耗很少，任务的大部分时间都在等待 IO 操作完成（因为 IO 的速度远远低于 CPU 和内存的速度，不是一个数量级的）。

对于 IO 密集型任务，任务越多 CPU 效率越高，但也不是无限的开启多任务

## 服务模型

### 多进程服务模型

程序是一些保存在磁盘上的指令的有序集合，是静态的。**进程是程序执行的过程，包括了动态创建、调度和消亡的整个过程，进程是程序资源管理的最小单位**

多进程模型是启动多个服务进程

由于多进程地址空间不同，数据不能共享，一个进程内创建的变量在另一个进程是无法访问

#### 常见进程间通信方式

##### 管道 Pipe

管道的实质是一个内核缓冲区，进程以先进先出 `FIFO` 的方式从缓冲区存取数据。是一种半双工的通信方式，数据只能单向流动，而且只能在具有亲缘关系（父子进程间）的进程间通信

**管道工作原理**

1. 管道一端的进程顺序的将数据写入缓冲区，另一端的进程则顺序的读出数据。
2. 缓冲区可以看做是一个循环队列，一个数据只能被读一次，读出来后在缓冲区就不复存在了。
3. 当缓冲区为读空或写满，读数据的进程或写数据进程进入等待队列。
4. 空的缓冲区有新数据写入，或者满的缓冲区有数据读出时，唤醒等待队列中的进程继续读写。

##### 命名管道 FIFO

上面介绍的管道也称为匿名管道，只能用于亲缘关系的进程间通信。为了克服这个缺点，出现了有名管道 FIFO 。有名管道提供了一个路径名与之关联，以文件形式存在于文件系统中，这样即使不存在亲缘关系的进程，只要可以访问该路径也能相互通信

##### 信号 Signal

信号是Linux系统中用于进程间互相通信或者操作的一种机制，信号可以在任何时候发给某一进程，无需知道该进程的状态。如果该进程当前不是执行态，内核会暂时保存信号，当进程恢复执行后传递给它。

如果一个信号被进程设置为阻塞，则该信号的传递被延迟，直到其阻塞被取消时才被传递给进程

##### 消息队列  Message Queue

##### 共享内存 Shared memory

共享内存是一个进程把地址空间的一段，映射到能被其他进程所访问的内存，一个进程创建、多个进程可访问，进程就可以直接读写这一块内存而不需要进行数据的拷贝，从而大大提高效率。

共享内存使得多个进程可以可以直接读写同一块内存空间，是最快的可用 IPC 形式

##### 套接字 Socket

我们熟悉的 TCP/IP 协议栈，也是建立在 socket 通信之上，TCP/IP 构建起了当前的互联网通信网络

它是一种通信机制，凭借这种机制，既可以在本机进程间通信，也可以跨网络通过，因为，套接字通过网络接口将数据发送到本机的不同进程或远程计算机的进程

### 多线程服务模型

#### 多线程同步和互斥方法

##### 互斥锁

互斥锁的作用是对临界区加以保护，以使任意时刻只有一个线程能够执行临界区的代码，实现了多线程对临界资源的互斥访问